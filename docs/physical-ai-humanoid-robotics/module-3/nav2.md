# Nav2: The ROS 2 Navigation Stack

Nav2 is the second generation of the official ROS Navigation Stack. It is a powerful, flexible, and production-ready system that allows a robot to autonomously navigate from point A to point B while safely avoiding obstacles.

While it works out-of-the-box for many wheeled robots, its true strength lies in its modular architecture, which allows it to be adapted for complex robots like humanoids.

## The Nav2 Architecture: A System of Servers

Nav2 is not a single program. It is a coordinated system of independent ROS 2 nodes, each running as a separate **Action Server**. This modularity makes the system robust and easy to customize. A **Lifecycle Manager** node is responsible for starting and stopping all the other servers in a controlled way.

The main servers are:

1.  **BT Navigator Server (The "Brain"):** This is the high-level executive. It receives a goal from the user and uses a **Behavior Tree** to orchestrate the entire navigation process. It calls on the other servers to plan, control, and recover from errors.

2.  **Planner Server (The Global Planner):** Its job is to find a long-term path from the robot's current location to the goal. It operates on the `global_costmap` and uses algorithms like Dijkstra's or A* to find an optimal path.

3.  **Controller Server (The Local Planner):** Its job is to follow the global path. It computes safe velocity commands (`cmd_vel`) that the robot's base should execute. It operates on the `local_costmap` to react to immediate obstacles that might not have been present when the global plan was made. Common algorithms include DWB (Dynamic Window Approach) and TEB (Timed Elastic Band).

4.  **Smoother Server:** An optional server that can be used to "clean up" the path generated by the Planner Server, making it smoother and more natural for the robot to follow.

5.  **Behavior Server:** This server hosts a library of "recovery behaviors" that the BT Navigator can call upon when the robot gets stuck. Examples include spinning in place or backing up to get a clearer view.

## The World Representation: Costmaps

Nav2 "sees" the world through **costmaps**. A costmap is a 2D grid where each cell has a value representing its "cost." A high cost means there's an obstacle, while a low cost means the area is free. Nav2 uses two main costmaps:

*   **`global_costmap`**: A large map, usually the size of the entire known environment. It's used by the Planner Server to create the long-term path.
*   **`local_costmap`**: A smaller map, centered on the robot, that is updated frequently. It's used by the Controller Server to avoid immediate, dynamic obstacles while trying to follow the global path.

## The Power of Behavior Trees

Unlike the rigid state machines of its ROS 1 predecessor, Nav2 uses **Behavior Trees (BTs)** to control its logic. BTs are a much more powerful and flexible way to define complex robot behavior. They make it easy to create sequences of actions with built-in recovery mechanisms.

For example, a simple navigation BT might look like this:
*"Compute a global plan. As long as the plan is not complete, follow the path. If you get stuck, back up a little and then try again."*
This makes the robot's behavior far more robust and human-like.

## Adapting Nav2 for Bipedal Humanoids

Nav2's modularity is what makes it suitable for complex robots like humanoids. While the default plugins are for wheeled robots, we can swap them out.

*   **Custom Controller is Key:** The most critical change is to replace the default `Controller Server` plugin. Instead of a plugin that outputs `cmd_vel` for wheels, a humanoid requires a custom "gait generator" or "footstep controller." This new controller would still take the global path as input, but its output would be a series of joint commands to execute a stable walking motion.

*   **Footstep Planning:** The path from the `Planner Server` can be used as a rough guideline. This guideline is then fed into a specialized **footstep planner** that calculates the exact `(x, y, z)` coordinates for each footfall needed to follow the path while maintaining balance.

*   **3D World Models:** Bipedal locomotion often requires navigating more complex 3D terrain than a flat floor. The standard 2D costmaps can be augmented or replaced with 3D world representations (like an OctoMap) to give the planner more information about the environment's topology.
